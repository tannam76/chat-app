<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat vÃ  Gá»i Video</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸ¤ Chat & Video Call</h1>
            <p>á»¨ng dá»¥ng chat vÃ  gá»i video thá»i gian thá»±c</p>
        </header>
        <!-- Fallback náº¿u chÆ°a login -->
        <div id="authFallback" class="auth-section full-width" style="display: none;">
            <h2>ğŸ” Vui lÃ²ng Ä‘Äƒng nháº­p</h2>
            <p><a href="/login">Äi Ä‘áº¿n trang Ä‘Äƒng nháº­p</a></p>
            <button onclick="window.location.href='/login'" class="call-button">ÄÄƒng Nháº­p</button>
        </div>
        <div id="mainContent" class="main-grid" style="display: none;">
            <div class="content-grid">
                <div class="chat-section">
                    <h2>ğŸ’¬ Chat Room</h2>
                    <div class="room-controls">
                        <input type="text" id="roomInput" placeholder="Nháº­p tÃªn phÃ²ng (máº·c Ä‘á»‹nh: general)">
                        <button onclick="joinRoom()">Tham gia</button>
                        <button id="leaveRoomBtn" onclick="leaveRoom()" style="display: none; background: #dc3545;">ğŸšª Rá»i PhÃ²ng</button>
                        <span id="currentRoomSpan" style="color: #667eea; font-weight: 500; margin-left: auto;"></span>
                    </div>
                    <div id="chatBox"></div>
                    <div class="message-controls">
                        <input type="text" id="messageInput" placeholder="Nháº­p tin nháº¯n..." onkeypress="if(event.key==='Enter') sendMessage()">
                        <button onclick="sendMessage()">Gá»­i</button>
                        
                        <!-- NÃºt ghi Ã¢m -->
                        <button id="voiceRecordBtn" class="voice-btn" title="Giá»¯ Ä‘á»ƒ ghi Ã¢m">
                            ğŸ™ï¸
                        </button>
                        
                        <!-- NÃšT Gá»¬I áº¢NH â€“ FIX 100% -->
<label for="fileInput" id="fileBtn" style="cursor: pointer; margin: 0; padding: 10px 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 50px; font-weight: bold;">
    File
</label>
<input type="file" id="fileInput" accept="image/*" style="display: none;" />

<script>
// Trigger chá»n file khi nháº¥n nÃºt
document.getElementById('fileBtn').addEventListener('click', () => {
    document.getElementById('fileInput').click();
});

// Gá»­i file khi chá»n xong
document.getElementById('fileInput').addEventListener('change', () => {
    if (document.getElementById('fileInput').files[0]) {
        sendFile(); // hÃ m sendFile() Ä‘Ã£ cÃ³ sáºµn trong client.js
    }
});
</script>
                    </div>
                </div>
                <div class="video-section">
    <h2>ğŸ“¹ Gá»i Video</h2>
    <div class="video-container">
        <video id="localVideo" autoplay muted class="video-local"></video>
        <video id="remoteVideo" autoplay class="video-remote"></video>
    </div>
    <!-- NÃºt toggle Mic & Camera - LuÃ´n hiá»ƒn thá»‹ sau login -->
    <div class="toggle-controls" id="toggleControls" style="display: flex; justify-content: center; gap: 10px; margin: 10px 0;">
        <button onclick="toggleCamera()" id="cameraBtn" class="toggle-btn" title="Táº¯t/Báº­t Camera" disabled>ğŸ“·</button>
        <button onclick="toggleMic()" id="micBtn" class="toggle-btn" title="Táº¯t/Báº­t Mic" disabled>ğŸ¤</button>
    </div>
    
    <!-- NÃºt gá»i -->
    <button onclick="startCall()" id="startCallBtn" class="call-button">ğŸ“ Báº¯t Ä‘áº§u Gá»i</button>
    
    <!-- NÃºt káº¿t thÃºc gá»i (hiá»‡n khi Ä‘ang gá»i) -->
    <button onclick="endCall()" id="endCallBtn" class="call-button" style="display:none; background: #ff6b6b;">ğŸ“ Káº¿t thÃºc</button>
    
    <!-- NÃºt cháº¥p nháº­n/tá»« chá»‘i (hiá»‡n khi cÃ³ incoming call) -->
    <div id="incomingCallControls" class="button-group" style="display: none; justify-content: center; gap: 20px; margin: 10px 0;">
        <button onclick="acceptCall()" class="call-button" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); flex: 0 1 120px;">âœ… Cháº¥p nháº­n</button>
        <button onclick="rejectCall()" class="call-button" style="background: #dc3545; flex: 0 1 120px;">âŒ Tá»« chá»‘i</button>
    </div>
    
    <button onclick="logout()" class="call-button" style="background: #6c757d;">ğŸšª ÄÄƒng Xuáº¥t</button>
</div>
                <!-- Pháº§n Game RPS -->
                <div class="game-section" id="rpsSection" style="display: none;">
                    <h2>ğŸ® KÃ©o BÃºa Bao</h2>
                    <div class="rps-choices">
                        <button class="rps-choice-btn" onclick="sendRPSChoice('rock'); return false;" title="KÃ©o">âœŠ</button>
                        <button class="rps-choice-btn" onclick="sendRPSChoice('paper'); return false;" title="BÃºa">âœ‹</button>
                        <button class="rps-choice-btn" onclick="sendRPSChoice('scissors'); return false;" title="Bao">âœŒï¸</button>
                    </div>
                    <div id="rpsResult" style="display: none;"></div>
                    <button onclick="updateRPSUI()" class="call-button" style="width: 100%; margin-top: 10px; background: #6c757d; display: none;" id="resetRPSBtn">ğŸ”„ ChÆ¡i Láº¡i</button>
                </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script type="module" src="js/main.js"></script>
    <script>
        // Kiá»ƒm tra login khi load
        window.addEventListener('load', async () => {
            const token = localStorage.getItem('token');
            if (!token) {
                document.getElementById('authFallback').style.display = 'block';
                document.getElementById('mainContent').style.display = 'none';
            } else {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    localStorage.setItem('username', payload.username);
                } catch (e) {
                    localStorage.removeItem('token');
                    window.location.href = '/login';
                    return;
                }
                document.getElementById('authFallback').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            }
        });

        function logout() {
            localStorage.clear();
            window.location.href = '/login';
        }
    </script>

    <div id="recordingOverlay" style="display:none; position:fixed; bottom:90px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.85); color:white; padding:16px 32px; border-radius:50px; z-index:9999; font-weight:bold; box-shadow:0 8px 32px rgba(0,0,0,0.4);">
    <span id="recordingTime">00:00</span>
    <span style="margin-left:12px;">Äang ghi Ã¢m... Tháº£ Ä‘á»ƒ gá»­i</span>
</div>
</body>
</html>